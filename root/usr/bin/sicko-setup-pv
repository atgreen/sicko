#!/bin/sh

set -x

# Run this very early in the boot process

if ! test -f /satellite-state/.copied; then

    # Copy /etc and /var to our PV
    tar cpf - /etc | (cd /satellite-state; tar xvf -)
    tar cpf - /var | (cd /satellite-state; tar xvf -)

    # Work-around some relative links
    ln -s /usr /satellite-state/usr
    rm /satellite-state/var/run
    ln -s /run /satellite-state/var/run
    rm /satellite-state/var/lock
    ln -s /run/lock /satellite-state/var/lock

    # Indicate that we are done
    touch /satellite-state/var/.sicko-copied
    
fi

mv /etc /etc.orig && ln -s /satellite-state/etc /etc
mv /var /var.orig && ln -s /satellite-state/var /var

